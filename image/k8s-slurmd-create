#!/usr/bin/bash
set -euo pipefail

echo "$(date) Resume invoked $0 $*" >> /var/log/slurm/power_save.log

echo "Arguments: $* $0 $1" >> /var/log/slurm/power_save.log

hosts=$(scontrol show hostnames $1) # this is purely a textual expansion, doens't depend on defined nodes
echo "Powering up hosts: $hosts" >> /var/log/slurm/power_save.log
for host in $hosts
do
   echo "Creating $host" >> /var/log/slurm/power_save.log
   sed s/SLURMD_NODENAME/$host/ /etc/slurm/slurmd-pod-template.yml | tee /dev/tty | kubectl create -f - | tee /dev/tty
   echo "done" >> /var/log/slurm/power_save.log
done
